"""
2층 신경망 (Neural Network)
"""
import numpy as np
from ch04_신경망학습.ex03 import cross_entropy
from ch04_신경망학습.ex05 import numerical_gradient
from dataset.mnist import load_mnist


class Twolayernetwork :
    def __init__(self,input_size,hidden_size,output_size,
                 weight_init_std=0.01):
        """ 입력이 784개이고(28*28),
        첫 번째 레이어 : 32개
        출력층 뉴런 개수 : 10개
        Weight 행렬 (W1, W2), bias : (b1,b2)을 난수로 생성"""
        np.random.seed(1231)
        self.params = dict()
        self.params['W1'] = weight_init_std *np.random.randn(input_size,hidden_size)
        self.params['b1'] = np.zeros(hidden_size)
        self.params['W2'] = weight_init_std *np.random.randn(hidden_size,output_size)
        self.params['b2'] = np.zeros(output_size)

    def sigmoid(self, x):
        return (1 / (1 + np.exp(-x)))

    def softmax(self, X):
        dimension = X.ndim
        if dimension == 1:
            m = np.max(X)
            X = X - m # overflow를 방지하기 위해서
            y = np.exp(X) / np.sum(np.exp(X))
        elif dimension == 2:
            Xt = X.T
            m = np.max(Xt, axis=0)
            Xt = Xt - m
            y = np.exp(Xt) / np.sum(np.exp(Xt), axis=0) # 전치행렬이기 때문에 axis = 0
            y = y.T

        return y

    def predict(self,x):
        z = x.dot(self.params['W1']) +self.params['b1']
        z1 = self.sigmoid(z)
        z2 = z1.dot(self.params['W2']) + self.params['b2']
        y= self.softmax(z2)
        return y

    def accuracy(self,x,y_true):
        """ x 는 2차원 배열, y_ true 2차원 배열 """
        y_pred = self.predict(x)
        predictions = np.argmax(y_pred, axis = 1)
        true_values = np.argmax(y_true , axis = 1)
        print(predictions)
        print(true_values)
        acc = np.mean(predictions == true_values)
        return acc

    def loss(self, x, y_true):
        y_pred = self.predict(x)
        entropy = self.cross_entropy(y_true, y_pred)
        return entropy

    def cross_entropy(self,y_true, y_pred):
        if y_pred.ndim == 1:
            y_pred = y_pred.reshape((1,y_pred.size))
            y_true = y_true.reshape((1,y_true.size))
        true_values = np.argmax(y_true, axis =1)
        n = y_pred.shape[0]
        rows = np.arange(n)
        log_p = np.log(y_pred[rows,true_values])
        entropy = -np.sum(log_p) / n
        return entropy


    def gradient(self,x,y_true):
        loss_fn = lambda W : self.loss(x,y_true)
        gradients = dict()
        for key in self.params:
            gradients[key] = self.numerical_gradient(loss_fn,
                                                     self.params[key])
        return gradients

    def numerical_gradient(self,fn,x):
        h = 1e-4
        gradient = np.zeros_like(x)
        with np.nditer(x,flags = ['c_index','multi_index'],op_flags = ['readwrite']) as it :
            while not it.finished :
                i = it.multi_index
                ith_value = it[0]
                it[0] = ith_value + h
                fh1 = fn(x)
                it[0] = ith_value- h
                fh2 = fn(x)
                gradient[i] = (fh1-fh2) / (2*h)
                it[0] = ith_value
                it.iternext()
        return gradient


if __name__ == "__main__" :
    neural_net = Twolayernetwork(input_size =784,
                                 hidden_size = 32,
                                 output_size = 10)
    print("neural_net.W1",neural_net.params['W1'].shape)
    print("neural_net.W2",neural_net.params['W2'].shape)
    (X_train,y_train),(X_test,y_test) = load_mnist(one_hot_label=True)
    x_pred = neural_net.predict(X_train[0])
    print(y_train[0])
    print(neural_net.predict(X_train[:5]))
    print(y_train[:5])
    print(neural_net.accuracy(X_train[:10],y_train[:10]))
    print(neural_net.loss(X_train[:10],y_train[:10]))

    # X_train[:5]를 신경망에 전파시켜서 예측값 확인
    y_pred1 = neural_net.predict(X_train[:5])
    print('y_pred1 =', y_pred1)
    print('y_true =', y_train[:5])
    print('cross entropy =', neural_net.loss(X_train[:5], y_train[:5]))

    # accuracy, loss 메소드 테스트
    acc = neural_net.accuracy(X_train[:100], y_train[:100])
    print('accuracy =', acc)
    print('cross entropy =', neural_net.loss(X_train[:100], y_train[:100]))

    # gradients 메소드 테스트
    gradients = neural_net.gradient(X_train[:100], y_train[:100])
    for key in gradients :
        print(key,np.sum(gradients[key]))

    lr = 0.1
    for key in gradients :
        neural_net.params[key] -= lr *gradients[key]
        







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































